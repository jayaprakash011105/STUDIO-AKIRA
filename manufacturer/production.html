<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Status - STUDIO AKIRA</title>
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <!-- CSS -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/admin-new.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>

<body class="admin-body">
    <aside class="admin-sidebar glass">
        <div class="admin-logo">studio akira</div>
        <nav class="admin-nav">
            <div class="nav-group-label">Manufacturer Portal</div>
            <a href="dashboard.html" class="admin-nav-item">
                <span class="admin-nav-icon">üìä</span>
                <span>Dashboard</span>
            </a>
            <a href="orders.html" class="admin-nav-item">
                <span class="admin-nav-icon">üì¶</span>
                <span>Orders</span>
            </a>
            <a href="production.html" class="admin-nav-item active">
                <span class="admin-nav-icon">üè≠</span>
                <span>Production</span>
            </a>
            <a href="inventory.html" class="admin-nav-item">
                <span class="admin-nav-icon">üì¶</span>
                <span>Inventory</span>
            </a>
            <a href="batches.html" class="admin-nav-item">
                <span class="admin-nav-icon">üè∑Ô∏è</span>
                <span>Batches</span>
            </a>
        </nav>
        <div class="admin-nav-footer">
            <a href="#" class="admin-nav-item" onclick="logout()">
                <span class="admin-nav-icon">üö™</span>
                <span>Logout</span>
            </a>
        </div>
    </aside>

    <main class="admin-main">
        <header class="admin-header">
            <div class="header-welcome">
                <h1>Production Status</h1>
                <p>Track active batches from pouring to packaging.</p>
            </div>
        </header>

        <section class="queue-section glass">
            <div class="queue-header">
                <h2 style="margin: 0; font-size: 1.25rem;">Live Workshop Tracks</h2>
                <span class="badge badge-warning" id="activeBatchCount">0 Active</span>
            </div>
            <div class="premium-table-container">
                <table class="premium-table">
                    <thead>
                        <tr>
                            <th>Batch ID</th>
                            <th>Product</th>
                            <th>Status</th>
                            <th>Quantity</th>
                            <th>Started</th>
                            <th>Progress Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productionList">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: var(--admin-text-muted);">
                                Monitoring workshop...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <script src="../js/firebase-config.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        checkRole(['manufacturer']).then(user => {
            if (user) syncActiveBatches();
        });

        function syncActiveBatches() {
            db.collection('productionBatches')
                .where('status', 'not-in', ['packaged', 'delivered'])
                .onSnapshot(snap => {
                    const tbody = document.getElementById('productionList');
                    document.getElementById('activeBatchCount').textContent = `${snap.size} Active`;

                    if (snap.empty) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">‚ú® No active production batches.</td></tr>';
                        return;
                    }

                    let html = '';
                    snap.forEach(doc => {
                        const batch = doc.data();
                        html += `
                            <tr>
                                <td style="font-weight: 600;">#${batch.batchNumber || doc.id.substring(0, 6)}</td>
                                <td style="font-weight: 500;">${batch.productName}</td>
                                <td>${getStatusBadge(batch.status)}</td>
                                <td>${batch.quantity} units</td>
                                <td style="font-size: 0.85rem; color: var(--admin-text-muted);">${formatDate(batch.startedAt)}</td>
                                <td>
                                    <div class="queue-actions">
                                        ${getNextStatusBtn(doc.id, batch.status, batch.orderId)}
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    tbody.innerHTML = html;
                });
        }

        function getNextStatusBtn(batchId, currentStatus, orderId) {
            if (currentStatus === 'pouring') {
                return `<button class="btn-premium btn-premium-primary" onclick="updateBatchStatus('${batchId}', 'curing', '${orderId}')">Move to Curing</button>`;
            } else if (currentStatus === 'curing') {
                return `<button class="btn-premium btn-premium-primary" onclick="updateBatchStatus('${batchId}', 'packaged', '${orderId}')">Mark as Packaged</button>`;
            }
            return '';
        }

        async function updateBatchStatus(batchId, nextStatus, orderId) {
            if (!confirm(`Move batch to ${nextStatus}?`)) return;
            try {
                showLoading(true);
                await db.collection('productionBatches').doc(batchId).update({
                    status: nextStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // If marked as packaged, update the actual order
                if (nextStatus === 'packaged') {
                    await db.collection('orders').doc(orderId).update({
                        productionStatus: 'packaged',
                        packagedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'shipped' // Automatically move to shipping phase
                    });
                    showToast('Batch completed and order marked for shipping!', 'success');
                } else {
                    showToast(`Batch moved to ${nextStatus}.`, 'success');
                }
            } catch (error) {
                console.error('Update status error:', error);
                showToast('Failed to update status', 'error');
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>

</html>