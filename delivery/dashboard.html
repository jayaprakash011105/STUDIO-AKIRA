<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Overview - STUDIO AKIRA</title>
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <!-- CSS -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/admin-new.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>

<body class="admin-body">
    <!-- Sidebar -->
    <aside class="admin-sidebar glass">
        <div class="admin-logo">studio akira</div>
        <nav class="admin-nav">
            <div class="nav-group-label">Logistics Portal</div>
            <a href="dashboard.html" class="admin-nav-item active">
                <span class="admin-nav-icon">üöö</span>
                <span>Dashboard</span>
            </a>
            <a href="orders.html" class="admin-nav-item">
                <span class="admin-nav-icon">üì¶</span>
                <span>Pickup Hub</span>
            </a>
            <a href="tracking.html" class="admin-nav-item">
                <span class="admin-nav-icon">üìç</span>
                <span>Active Tracks</span>
            </a>
        </nav>
        <div class="admin-nav-footer">
            <a href="#" class="admin-nav-item" onclick="logout()">
                <span class="admin-nav-icon">üö™</span>
                <span>Logout</span>
            </a>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="admin-main">
        <header class="admin-header">
            <div class="header-welcome">
                <h1>Delivery Dashboard</h1>
                <p>Ensuring every candle finds its home safely.</p>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="admin-grid">
            <div class="admin-card">
                <div class="stat-header">
                    <div class="stat-icon">üì¶</div>
                </div>
                <div class="stat-value" id="pendingPickup">0</div>
                <div class="stat-label">Ready for Pickup</div>
            </div>

            <div class="admin-card">
                <div class="stat-header">
                    <div class="stat-icon">üöö</div>
                </div>
                <div class="stat-value" id="inTransit">0</div>
                <div class="stat-label">In Transit (My)</div>
            </div>

            <div class="admin-card">
                <div class="stat-header">
                    <div class="stat-icon">üèÅ</div>
                </div>
                <div class="stat-value" id="completedDeliveries">0</div>
                <div class="stat-label">Delivered (Total)</div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <!-- Pickup Hub Preview -->
            <section class="queue-section glass">
                <div class="queue-header">
                    <h2 style="margin: 0; font-size: 1.25rem;">Nearby Pickups</h2>
                    <a href="orders.html"
                        style="color: var(--admin-accent); font-weight: 600; text-decoration: none; font-size: 0.9rem;">Go
                        to Hub ‚Üí</a>
                </div>
                <div class="premium-table-container">
                    <table class="premium-table">
                        <thead>
                            <tr>
                                <th>Order</th>
                                <th>Warehouse</th>
                                <th>Items</th>
                            </tr>
                        </thead>
                        <tbody id="pickupList">
                            <tr>
                                <td colspan="3"
                                    style="text-align: center; padding: 2rem; color: var(--admin-text-muted);">Scanning
                                    for packages...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Active Deliveries -->
            <section class="queue-section glass">
                <div class="queue-header">
                    <h2 style="margin: 0; font-size: 1.25rem;">Your active deliveries</h2>
                    <a href="tracking.html"
                        style="color: var(--admin-accent); font-weight: 600; text-decoration: none; font-size: 0.9rem;">Track
                        Live ‚Üí</a>
                </div>
                <div class="premium-table-container">
                    <table class="premium-table">
                        <thead>
                            <tr>
                                <th>Order</th>
                                <th>Destination</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="activeTracks">
                            <tr>
                                <td colspan="3"
                                    style="text-align: center; padding: 2rem; color: var(--admin-text-muted);">Syncing
                                    routes...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>

    <!-- Scripts -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        let currentUser;
        checkRole(['delivery']).then(user => {
            if (user) {
                currentUser = user;
                initDashboard();
            }
        });

        function initDashboard() {
            startLogisticsSync();
        }

        function startLogisticsSync() {
            // 1. Ready for Pickup Sync (Orders packaged but not assigned)
            db.collection('orders')
                .where('status', 'in', ['packaged', 'shipped'])
                .where('assignedToDelivery', '==', null)
                .onSnapshot(snap => {
                    document.getElementById('pendingPickup').textContent = snap.size;
                    updatePickupPreview(snap);
                });

            // 2. My In-Transit Deliveries
            db.collection('orders')
                .where('assignedToDelivery', '==', currentUser.uid)
                .where('status', 'in', ['picked_up', 'out_for_delivery'])
                .onSnapshot(snap => {
                    document.getElementById('inTransit').textContent = snap.size;
                    updateActiveTracks(snap);
                });

            // 3. Completed Deliveries (Total System)
            db.collection('orders')
                .where('status', '==', 'delivered')
                .onSnapshot(snap => {
                    document.getElementById('completedDeliveries').textContent = snap.size;
                });
        }

        function updatePickupPreview(snap) {
            const tbody = document.getElementById('pickupList');
            if (snap.empty) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 1.5rem;">No packages waiting.</td></tr>';
                return;
            }
            let html = '';
            snap.docs.slice(0, 5).forEach(doc => {
                const order = doc.data();
                html += `
                    <tr>
                        <td style="font-weight: 600;">#${doc.id.substring(0, 8).toUpperCase()}</td>
                        <td>Studio Warehouse</td>
                        <td>${order.items?.length || 0} items</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        function updateActiveTracks(snap) {
            const tbody = document.getElementById('activeTracks');
            if (snap.empty) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 1.5rem;">No active routes.</td></tr>';
                return;
            }
            let html = '';
            snap.docs.slice(0, 5).forEach(doc => {
                const order = doc.data();
                html += `
                    <tr>
                        <td style="font-weight: 600;">#${doc.id.substring(0, 8).toUpperCase()}</td>
                        <td style="font-size: 0.85rem;">${order.customerDetails?.city || 'Local'}</td>
                        <td>${getStatusBadge(order.status)}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }
    </script>
</body>

</html>