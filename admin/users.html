<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - STUDIO AKIRA Admin</title>

    <!-- CSS -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        .users-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .search-box {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            max-width: 400px;
            padding: 12px 20px;
            border: 1px solid var(--color-light-gray);
            border-radius: var(--radius-md);
            font-size: 1rem;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 10px 20px;
            background: white;
            border: 2px solid var(--color-light-gray);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .filter-tab:hover {
            border-color: var(--color-sage);
            background: var(--color-sage-light);
        }

        .filter-tab.active {
            background: var(--color-sage);
            color: white;
            border-color: var(--color-sage);
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--color-sage);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-sage-dark);
        }

        .stat-label {
            color: var(--color-text-light);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--color-sage-light);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--color-sage-dark);
            margin-right: 10px;
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-logo">studio akira</div>
        <ul class="sidebar-menu">
            <li class="sidebar-item"><a href="dashboard.html" class="sidebar-link">üìä Dashboard</a></li>
            <li class="sidebar-item"><a href="products.html" class="sidebar-link">üïØÔ∏è Products</a></li>
            <li class="sidebar-item"><a href="orders.html" class="sidebar-link">üì¶ Orders</a></li>
            <li class="sidebar-item"><a href="users.html" class="sidebar-link active">üë• Users</a></li>
            <li class="sidebar-item"><a href="approvals.html" class="sidebar-link">‚úÖ Approvals</a></li>
            <li class="sidebar-item"><a href="financial.html" class="sidebar-link">üí∞ Financial</a></li>
            <li class="sidebar-item"><a href="content.html" class="sidebar-link">üìù Content</a></li>
            <li class="sidebar-item"><a href="#" class="sidebar-link" onclick="logout()">üö™ Logout</a></li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="users-header">
            <div>
                <h1>User Management</h1>
                <p style="color: var(--color-text-light);">Manage all users and their access levels</p>
            </div>
        </div>

        <!-- User Statistics -->
        <div class="user-stats">
            <div class="stat-card">
                <div class="stat-value" id="totalUsersCount">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="customersCount">0</div>
                <div class="stat-label">Customers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="manufacturersCount">0</div>
                <div class="stat-label">Manufacturers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="deliveryCount">0</div>
                <div class="stat-label">Delivery Partners</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeUsersCount">0</div>
                <div class="stat-label">Active Users</div>
            </div>
        </div>

        <!-- Search Box -->
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="üîç Search by name, email, or phone..."
                onkeyup="searchUsers()">
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <button class="filter-tab active" onclick="filterUsers('all')">All Users</button>
            <button class="filter-tab" onclick="filterUsers('customer')">Customers</button>
            <button class="filter-tab" onclick="filterUsers('manufacturer')">Manufacturers</button>
            <button class="filter-tab" onclick="filterUsers('delivery')">Delivery Partners</button>
            <button class="filter-tab" onclick="filterUsers('admin')">Admins</button>
        </div>

        <!-- Users Table -->
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Contact</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTable">
                    <tr>
                        <td colspan="6" class="text-center">Loading users...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Loading Spinner -->
    <div id="loading-spinner">
        <div class="spinner"></div>
    </div>

    <!-- Scripts -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        let currentFilter = 'all';
        let allUsers = [];

        checkRole(['admin']).then(user => {
            if (user) {
                loadUsers();
            }
        });

        async function loadUsers() {
            try {
                const snapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
                allUsers = [];

                snapshot.forEach(doc => {
                    allUsers.push({ id: doc.id, ...doc.data() });
                });

                updateUserStats();
                displayUsers();
            } catch (error) {
                console.error('Error loading users:', error);
                showToast('Error loading users', 'error');
                document.getElementById('usersTable').innerHTML = '<tr><td colspan="6" class="text-center">Error loading users. Please refresh.</td></tr>';
            }
        }

        function updateUserStats() {
            const total = allUsers.length;
            const customers = allUsers.filter(u => u.role === 'customer').length;
            const manufacturers = allUsers.filter(u => u.role === 'manufacturer').length;
            const delivery = allUsers.filter(u => u.role === 'delivery').length;
            const active = allUsers.filter(u => u.status === 'active').length;

            document.getElementById('totalUsersCount').textContent = total;
            document.getElementById('customersCount').textContent = customers;
            document.getElementById('manufacturersCount').textContent = manufacturers;
            document.getElementById('deliveryCount').textContent = delivery;
            document.getElementById('activeUsersCount').textContent = active;
        }

        function displayUsers() {
            let filteredUsers = allUsers;

            // Apply role filter
            if (currentFilter !== 'all') {
                filteredUsers = filteredUsers.filter(u => u.role === currentFilter);
            }

            // Apply search filter
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(u =>
                    (u.name && u.name.toLowerCase().includes(searchTerm)) ||
                    (u.email && u.email.toLowerCase().includes(searchTerm)) ||
                    (u.phone && u.phone.toLowerCase().includes(searchTerm))
                );
            }

            const tbody = document.getElementById('usersTable');

            if (filteredUsers.length === 0) {
                let emptyMessage = 'No users found';
                if (currentFilter === 'manufacturer') {
                    emptyMessage = 'No manufacturers yet. Manufacturers need to sign up and get approved.';
                } else if (currentFilter === 'delivery') {
                    emptyMessage = 'No delivery partners yet. Delivery partners need to sign up and get approved.';
                } else if (currentFilter === 'admin') {
                    emptyMessage = 'No other admins found.';
                } else if (searchTerm) {
                    emptyMessage = `No users found matching "${searchTerm}"`;
                }
                tbody.innerHTML = `<tr><td colspan="6" class="text-center" style="padding: 40px; color: var(--color-text-light);">${emptyMessage}</td></tr>`;
                return;
            }

            let html = '';
            filteredUsers.forEach(u => {
                const initial = u.name ? u.name.charAt(0).toUpperCase() : '?';
                const statusBadge = getStatusBadge(u.status || 'pending');
                const roleBadge = `<span class="badge badge-info">${u.role || 'N/A'}</span>`;

                // Logic to hide deactivate button for the main admin
                const isMainAdmin = u.email === 'admin@gmail.com';
                const actionButton = isMainAdmin ?
                    `<span class="badge badge-secondary">Protected</span>` :
                    (u.status === 'active' ?
                        `<button class="btn btn-small btn-error" onclick="deactivateUser('${u.id}', '${u.name}')">Deactivate</button>` :
                        `<button class="btn btn-small btn-success" onclick="activateUser('${u.id}', '${u.name}')">Activate</button>`
                    );

                html += `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center;">
                            <div class="user-avatar">${initial}</div>
                            <div>
                                <div style="font-weight: 600;">${u.name || 'N/A'}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>${u.email || 'N/A'}</div>
                        <div style="font-size: 0.85rem; color: var(--color-text-light);">${u.phone || 'No phone'}</div>
                    </td>
                    <td>${roleBadge}</td>
                    <td>${statusBadge}</td>
                    <td>${formatDate(u.createdAt)}</td>
                    <td>
                        <div class="action-buttons">
                            ${actionButton}
                            <button class="btn btn-small btn-secondary" onclick="viewUserDetails('${u.id}')">View</button>
                        </div>
                    </td>
                </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        function filterUsers(role) {
            currentFilter = role;
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            displayUsers();
        }

        function searchUsers() {
            displayUsers();
        }

        async function deactivateUser(userId, userName) {
            if (!confirm(`Are you sure you want to deactivate ${userName}?`)) return;

            try {
                showLoading(true);
                await db.collection('users').doc(userId).update({
                    status: 'inactive',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast('User deactivated successfully', 'success');
                loadUsers();
            } catch (error) {
                console.error('Error deactivating user:', error);
                showToast('Error deactivating user', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function activateUser(userId, userName) {
            if (!confirm(`Activate ${userName}?`)) return;

            try {
                showLoading(true);
                await db.collection('users').doc(userId).update({
                    status: 'active',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast('User activated successfully', 'success');
                loadUsers();
            } catch (error) {
                console.error('Error activating user:', error);
                showToast('Error activating user', 'error');
            } finally {
                showLoading(false);
            }
        }

        function viewUserDetails(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            alert(`User Details:\n\nName: ${user.name}\nEmail: ${user.email}\nPhone: ${user.phone || 'N/A'}\nRole: ${user.role}\nStatus: ${user.status}\nJoined: ${formatDate(user.createdAt)}`);
        }
    </script>
</body>

</html>