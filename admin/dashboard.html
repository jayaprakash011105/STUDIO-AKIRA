<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Overview - STUDIO AKIRA</title>

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/admin-new.css">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* Specific tweaks for dashboard */
        .admin-main {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
    </style>
</head>

<body class="admin-body">
    <!-- Sidebar Navigation -->
    <aside class="admin-sidebar glass">
        <div class="admin-logo">studio akira</div>

        <nav class="admin-nav">
            <div class="nav-group-label">Core Management</div>
            <a href="dashboard.html" class="admin-nav-item active">
                <span class="admin-nav-icon">üõ∏</span>
                <span>Overview</span>
            </a>
            <a href="products.html" class="admin-nav-item">
                <span class="admin-nav-icon">üïØÔ∏è</span>
                <span>Catalog</span>
            </a>
            <a href="orders.html" class="admin-nav-item">
                <span class="admin-nav-icon">üì¶</span>
                <span>Sales</span>
            </a>
            <a href="users.html" class="admin-nav-item">
                <span class="admin-nav-icon">üë•</span>
                <span>Community</span>
            </a>
            <a href="messages.html" class="admin-nav-item">
                <span class="admin-nav-icon">‚úâÔ∏è</span>
                <span>Messages</span>
            </a>

            <div class="nav-group-label" style="margin-top: 2rem;">System & Style</div>
            <a href="financial.html" class="admin-nav-item">
                <span class="admin-nav-icon">üí∞</span>
                <span>Financials</span>
            </a>
            <a href="content.html" class="admin-nav-item">
                <span class="admin-nav-icon">‚ú®</span>
                <span>Appearance</span>
            </a>
        </nav>

        <div class="admin-nav-footer">
            <a href="#" class="admin-nav-item" onclick="logout()">
                <span class="admin-nav-icon">üö™</span>
                <span>Logout</span>
            </a>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="admin-main">
        <header class="admin-header">
            <div class="header-welcome">
                <h1 id="welcomeText">Dashboard Overview</h1>
                <p id="currentDateText">Welcome back, let's see how we're doing.</p>
            </div>
            <div class="header-actions">
                <button class="btn-premium btn-premium-primary" onclick="window.location.href='products.html'">
                    <span>‚ûï</span> Add Product
                </button>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="admin-grid">
            <div class="admin-card">
                <div class="stat-header">
                    <div class="stat-icon">üí∞</div>
                </div>
                <div class="stat-value" id="totalRevenue">‚Çπ0</div>
                <div class="stat-label">Total Revenue</div>
            </div>

            <div class="admin-card">
                <div class="stat-header">
                    <div class="stat-icon">üì¶</div>
                </div>
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">Total Orders</div>
            </div>

            <div class="admin-card">
                <div class="stat-header">
                    <div class="stat-icon">üë•</div>
                </div>
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">Active Customers</div>
            </div>

            <div class="admin-card">
                <div class="stat-header">
                    <div class="stat-icon">üïØÔ∏è</div>
                </div>
                <div class="stat-value" id="totalProducts">0</div>
                <div class="stat-label">Active Products</div>
            </div>

            <div class="admin-card" onclick="window.location.href='messages.html'" style="cursor: pointer;">
                <div class="stat-header">
                    <div class="stat-icon">‚úâÔ∏è</div>
                </div>
                <div class="stat-value" id="unreadMessages">0</div>
                <div class="stat-label">New Messages</div>
            </div>
        </div>

        <!-- Action Items Overlaying Recent Events -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <!-- Left: Pending Approvals & Alerts -->
            <section class="queue-section glass">
                <div class="queue-header">
                    <h2 style="margin: 0; font-size: 1.25rem;">Next Actions</h2>
                    <span class="badge badge-warning" id="pendingApprovalsCount">0 Pending</span>
                </div>
                <div id="actionQueue">
                    <div class="text-center" style="padding: 2rem; color: var(--admin-text-muted);">
                        Loading active tasks...
                    </div>
                </div>
                <div style="margin-top: 1.5rem; text-align: right;">
                    <a href="users.html"
                        style="color: var(--admin-accent); font-weight: 600; text-decoration: none; font-size: 0.9rem;">View
                        All Users ‚Üí</a>
                </div>
            </section>

            <!-- Right: Recent Activity -->
            <section class="queue-section glass">
                <div class="queue-header">
                    <h2 style="margin: 0; font-size: 1.25rem;">Recent Sales</h2>
                    <a href="orders.html"
                        style="color: var(--admin-accent); font-weight: 600; text-decoration: none; font-size: 0.9rem;">View
                        All Orders ‚Üí</a>
                </div>
                <div id="recentOrders">
                    <div class="text-center" style="padding: 2rem; color: var(--admin-text-muted);">
                        Loading recent sales...
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Loading Spinner -->
    <div id="loading-spinner" style="display: none;">
        <div class="spinner"></div>
    </div>

    <!-- Scripts -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        // Check admin authentication
        checkRole(['admin']).then(user => {
            if (user) {
                initDashboard();
            }
        });

        let unsubStats = null, unsubQueue = null, unsubSales = null, unsubMsgs = null, unsubUsers = null, unsubProducts = null;

        function initDashboard() {
            startDashboardSync();

            // Set dynamic welcome text
            const hours = new Date().getHours();
            const welcomeMsg = hours < 12 ? 'Good Morning' : hours < 17 ? 'Good Afternoon' : 'Good Evening';
            document.getElementById('welcomeText').textContent = `${welcomeMsg}, Admin`;
            document.getElementById('currentDateText').textContent = new Date().toLocaleDateString('en-IN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function startDashboardSync() {
            if (unsubStats) unsubStats();
            if (unsubQueue) unsubQueue();
            if (unsubSales) unsubSales();
            if (unsubMsgs) unsubMsgs();
            if (unsubUsers) unsubUsers();
            if (unsubProducts) unsubProducts();

            unsubStats = db.collection('orders').onSnapshot(ordersSnap => {
                let totalRevenue = 0;
                ordersSnap.forEach(doc => totalRevenue += (doc.data().totalAmount || 0));
                document.getElementById('totalOrders').textContent = ordersSnap.size;
                document.getElementById('totalRevenue').textContent = formatPrice(totalRevenue);
            });

            // Independent User Sync
            unsubUsers = db.collection('users').where('role', '==', 'customer').onSnapshot(snap => {
                document.getElementById('totalUsers').textContent = snap.size;
            });

            // Independent Product Sync
            unsubProducts = db.collection('products').where('status', '==', 'active').onSnapshot(snap => {
                document.getElementById('totalProducts').textContent = snap.size;
            });

            // Sync New Messages
            unsubMsgs = db.collection('contactMessages').where('status', '==', 'unread').onSnapshot(snap => {
                document.getElementById('unreadMessages').textContent = snap.size;
            });

            // Sync Action Queue (Pending Approvals)
            unsubQueue = db.collection('approvalRequests')
                .where('status', '==', 'pending')
                .orderBy('requestedAt', 'desc')
                .limit(5)
                .onSnapshot(snapshot => {
                    const queueContainer = document.getElementById('actionQueue');
                    const pendingCountDisplay = document.getElementById('pendingApprovalsCount');

                    pendingCountDisplay.textContent = `${snapshot.size} Pending`;

                    if (snapshot.empty) {
                        queueContainer.innerHTML = `<div class="text-center" style="padding: 2rem; color: var(--admin-text-muted);">‚ú® All caught up! No pending actions.</div>`;
                        return;
                    }

                    let html = '';
                    snapshot.forEach(doc => {
                        const req = doc.data();
                        const initial = req.userName ? req.userName.charAt(0).toUpperCase() : '?';
                        html += `
                            <div class="queue-item">
                                <div class="queue-avatar">${initial}</div>
                                <div class="queue-content">
                                    <div class="queue-title">${req.userName}</div>
                                    <div class="queue-subtitle">Requested ${req.requestedRole} role ‚Ä¢ ${formatDate(req.requestedAt)}</div>
                                </div>
                                <div class="queue-actions">
                                    <button class="btn-premium btn-premium-primary" onclick="approveRequest('${doc.id}', '${req.userId}')">Approve</button>
                                    <button class="btn-premium btn-premium-outline" onclick="rejectRequest('${doc.id}', '${req.userId}')">Reject</button>
                                </div>
                            </div>
                        `;
                    });
                    queueContainer.innerHTML = html;
                });

            // Sync Recent Sales
            unsubSales = db.collection('orders')
                .orderBy('createdAt', 'desc')
                .limit(5)
                .onSnapshot(snapshot => {
                    const container = document.getElementById('recentOrders');
                    if (snapshot.empty) {
                        container.innerHTML = '<div class="text-center" style="padding: 2rem;">No sales yet.</div>';
                        return;
                    }

                    let html = '';
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const orderId = doc.id.substring(0, 8).toUpperCase();
                        html += `
                            <div class="queue-item">
                                <div class="queue-content">
                                    <div class="queue-title">Order #${orderId}</div>
                                    <div class="queue-subtitle">${order.customerDetails?.name || 'Guest'} ‚Ä¢ ${formatPrice(order.totalAmount)}</div>
                                </div>
                                <div>${getStatusBadge(order.status)}</div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                });
        }

        async function approveRequest(requestId, userId) {
            if (!confirm('Approve this request?')) return;
            try {
                showLoading(true);
                const currentUser = await getCurrentUser();
                await db.collection('approvalRequests').doc(requestId).update({
                    status: 'approved',
                    reviewedBy: currentUser.uid,
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                await db.collection('users').doc(userId).update({
                    status: 'active',
                    approvedBy: currentUser.uid,
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast('Request approved successfully', 'success');
                // Real-time listeners automatically update the UI
            } catch (error) {
                console.error('Error:', error);
                showToast('Error approving request', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function rejectRequest(requestId, userId) {
            if (!confirm('Reject this request?')) return;
            try {
                showLoading(true);
                const currentUser = await getCurrentUser();
                await db.collection('approvalRequests').doc(requestId).update({
                    status: 'rejected',
                    reviewedBy: currentUser.uid,
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                await db.collection('users').doc(userId).update({ status: 'rejected' });
                showToast('Request rejected', 'success');
                // Real-time listeners automatically update the UI
            } catch (error) {
                console.error('Error:', error);
                showToast('Error rejecting request', 'error');
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>

</html>
</body>

</html>