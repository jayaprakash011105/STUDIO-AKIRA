<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appearance & Content - STUDIO AKIRA</title>

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/admin-new.css">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <style>
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .theme-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            border: 2px solid #edf2f7;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .theme-card:hover {
            transform: translateY(-5px);
            border-color: var(--admin-accent);
            box-shadow: var(--admin-card-shadow);
        }

        .theme-card.active {
            border-color: var(--admin-accent);
            background: #fdfdfd;
        }

        .theme-card.active::before {
            content: 'Active';
            position: absolute;
            top: 15px;
            right: -25px;
            background: var(--admin-accent);
            color: white;
            padding: 5px 30px;
            transform: rotate(45deg);
            font-size: 0.7rem;
            font-weight: 700;
        }

        .color-preview {
            display: flex;
            gap: 8px;
            margin-bottom: 1rem;
        }

        .color-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #eee;
        }

        .section-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .section-card {
            background: white;
            padding: 1.25rem 2rem;
            border-radius: 16px;
            border: 1px solid #edf2f7;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease;
        }

        .section-card:hover {
            border-color: var(--admin-accent);
            background: #fcfcfc;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-dialog {
            background: white;
            padding: 32px;
            border-radius: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--admin-text-main);
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #edf2f7;
            border-radius: 12px;
            font-family: inherit;
        }

        .image-preview-container {
            margin-top: 10px;
            position: relative;
            width: 100%;
            height: 200px;
            border-radius: 12px;
            overflow: hidden;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #ddd;
        }

        .image-preview-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-preview-container:hover .upload-overlay {
            display: flex;
        }

        .progress-bar {
            width: 80%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--admin-accent);
            width: 0%;
            transition: width 0.3s ease;
        }

        .field-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .upload-overlay.uploading {
            display: flex !important;
            opacity: 1 !important;
        }

        .url-warning {
            display: none;
            color: #d63031;
            font-size: 0.8rem;
            margin-top: 5px;
            font-weight: 500;
        }

        .url-warning.show {
            display: block;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #ccc !important;
            border-color: #ccc !important;
        }
    </style>
</head>

<body class="admin-body">
    <!-- Sidebar Navigation -->
    <aside class="admin-sidebar glass">
        <div class="admin-logo">studio akira</div>

        <nav class="admin-nav">
            <div class="nav-group-label">Core Management</div>
            <a href="dashboard.html" class="admin-nav-item">
                <span class="admin-nav-icon">üõ∏</span>
                <span>Overview</span>
            </a>
            <a href="products.html" class="admin-nav-item">
                <span class="admin-nav-icon">üïØÔ∏è</span>
                <span>Catalog</span>
            </a>
            <a href="orders.html" class="admin-nav-item">
                <span class="admin-nav-icon">üì¶</span>
                <span>Sales</span>
            </a>
            <a href="users.html" class="admin-nav-item">
                <span class="admin-nav-icon">üë•</span>
                <span>Community</span>
            </a>
            <a href="messages.html" class="admin-nav-item">
                <span class="admin-nav-icon">‚úâÔ∏è</span>
                <span>Messages</span>
            </a>

            <div class="nav-group-label" style="margin-top: 2rem;">System & Style</div>
            <a href="financial.html" class="admin-nav-item">
                <span class="admin-nav-icon">üí∞</span>
                <span>Financials</span>
            </a>
            <a href="content.html" class="admin-nav-item active">
                <span class="admin-nav-icon">‚ú®</span>
                <span>Appearance</span>
            </a>
        </nav>

        <div class="admin-nav-footer">
            <a href="#" class="admin-nav-item" onclick="logout()">
                <span class="admin-nav-icon">üö™</span>
                <span>Logout</span>
            </a>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="admin-main">
        <header class="admin-header">
            <div class="header-welcome">
                <h1>Appearance & Style</h1>
                <p>Curate the visual experience of your luxury brand.</p>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <label class="form-label" style="margin-bottom: 0; white-space: nowrap;">Manage Area:</label>
                <select id="pageSelector" class="form-input" style="width: 200px; padding: 8px 12px;"
                    onchange="switchPage(this.value)">
                    <option value="homepage">Homepage</option>
                    <option value="about">About Us</option>
                    <option value="navigation">Global Navigation</option>
                </select>
                <button class="btn-premium btn-premium-outline" onclick="window.open('../index.html', '_blank')">
                    <span>üëÅÔ∏è</span> Preview Site
                </button>
            </div>
        </header>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="font-family: 'Playfair Display', serif;">Aesthetic Themes</h2>
        </div>
        <div class="theme-grid" id="themeGrid">
            <!-- Themes loaded via JS -->
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="font-family: 'Playfair Display', serif;">Homepage Sections</h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn-premium btn-premium-outline" style="padding: 8px 15px;" onclick="addSection()">‚ûï Add
                    Section</button>
                <button class="btn-premium btn-premium-outline" style="padding: 8px 15px;" onclick="loadSections()">üîÑ
                    Sync Layout</button>
            </div>
        </div>
        <div class="section-list" id="sectionsContainer">
            <!-- Sections loaded via JS -->
        </div>

        <div class="admin-card"
            style="margin-top: 3rem; background: #fafafa; border: 2px dashed #eee; text-align: center; padding: 3rem;">
            <h3 style="margin-bottom: 1rem;">Advanced Content Tools</h3>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <a href="cms-init.html" class="btn-premium btn-premium-outline">Initialize CMS</a>
                <button class="btn-premium btn-premium-outline" onclick="exportContent()">Export Configuration</button>
            </div>
        </div>
    </main>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-dialog">
            <h2 id="modalTitle" style="margin-top: 0; font-family: 'Playfair Display', serif;">Edit Section</h2>
            <div id="modalForm"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/cms.js"></script>
    <script>
        let currentSections = [];
        let currentThemes = {};
        let currentSettings = {};
        let editingSection = null;
        let unsubThemes = null;
        let unsubSections = null;
        let currentPage = 'homepage';

        function switchPage(pageId) {
            currentPage = pageId;
            loadSections();
        }

        checkRole(['admin']).then(user => {
            if (user) startContentSync();
        });

        function startContentSync() {
            if (unsubThemes) unsubThemes();
            if (unsubSections) unsubSections();

            // Sync Themes and Settings
            unsubThemes = db.collection('websiteContent').onSnapshot(snapshot => {
                snapshot.forEach(doc => {
                    if (doc.id === 'settings') {
                        currentSettings = doc.data();
                    } else if (doc.id === 'themes') {
                        currentThemes = doc.data();
                    }
                });
                renderThemes();
            }, e => showToast('Theme sync failed', 'error'));

            // Sync Homepage Sections
            // unsubSections = db.collection('websiteContent').doc('homepage').onSnapshot(doc => {
            //     if (doc.exists) {
            //         currentSections = doc.data().sections || [];
            //         renderSections();
            //     }
            // }, e => console.error('Section sync failed', e));
            loadSections(); // Call loadSections initially
        }

        async function loadSections() {
            try {
                showLoading(true);
                if (currentPage === 'navigation') {
                    const nav = await cms.loadNavigation();
                    currentSections = [{
                        id: 'navigation',
                        type: 'navigation',
                        order: 1,
                        active: true,
                        data: { links: cms.navigation }
                    }];
                } else {
                    const sectionsData = await cms.loadContent(currentPage);
                    currentSections = sectionsData.sections || [];
                }
                renderSections();
                showLoading(false);
            } catch (e) {
                console.error(e);
                showToast('Failed to load sections', 'error');
            }
        }

        function renderThemes() {
            const grid = document.getElementById('themeGrid');
            grid.innerHTML = Object.keys(currentThemes).map(id => {
                const theme = currentThemes[id];
                const active = currentSettings.activeThemeId === id;
                const colors = theme.colors || {};
                return `
                    <div class="theme-card ${active ? 'active' : ''}" onclick="switchTheme('${id}')">
                        <div class="color-preview">
                            <div class="color-dot" style="background: ${colors.sage || '#6b8a6b'}"></div>
                            <div class="color-dot" style="background: ${colors.sageLight || '#f4f7f4'}"></div>
                            <div class="color-dot" style="background: ${colors.text || '#2d3731'}"></div>
                        </div>
                        <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 5px;">${theme.name || id}</div>
                        <div style="font-size: 0.85rem; color: var(--admin-text-muted);">${theme.description || 'A unique visual aesthetic.'}</div>
                    </div>
                `;
            }).join('');
        }

        async function switchTheme(id) {
            try {
                showLoading(true);
                await db.collection('websiteContent').doc('settings').set({
                    activeThemeId: id,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                // No need to manually update state/UI - real-time listener will handle it
                showToast(`Modern style updated: ${id}`, 'success');
            } catch (e) { showToast('Switch failed', 'error'); } finally { showLoading(false); }
        }


        function renderSections() {
            const container = document.getElementById('sectionsContainer');
            const sorted = [...currentSections].sort((a, b) => (a.order || 0) - (b.order || 0));
            container.innerHTML = sorted.map(s => {
                const image = s.data?.image || s.data?.collections?.[0]?.image || s.data?.featuredImage;
                const thumbnail = image ? `<img src="${cms.fixPath(image)}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px; border: 1px solid #eee;">` :
                    `<div style="width: 50px; height: 50px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">${getSectionIcon(s.type)}</div>`;

                return `
                    <div class="section-card ${s.active === false ? 'inactive' : ''}">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            ${thumbnail}
                            <div>
                                <div style="font-weight: 700;">${getSectionName(s.type)}</div>
                                <div style="font-size: 0.8rem; color: var(--admin-text-muted);">Priority: ${s.order} ‚Ä¢ ${s.active !== false ? 'Active' : 'Hidden'}</div>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn-premium btn-premium-primary" style="padding: 8px 15px;" onclick="editSection('${s.id}')">Configure</button>
                            <button class="btn-premium btn-premium-outline" style="padding: 8px 15px;" onclick="toggleSection('${s.id}')">${s.active !== false ? 'Hide' : 'Show'}</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getSectionIcon(type) {
            return { hero: 'üè†', collections: 'üì¶', bestSellers: '‚≠ê', whyUs: '‚ú®', gifting: 'üéÅ', reviews: 'üí¨', newsletter: '‚úâÔ∏è', navigation: 'üß≠' }[type] || 'üìÑ';
        }

        function getSectionName(type) {
            return { hero: 'Hero Masterpiece', collections: 'Discovery Grid', bestSellers: 'Signature Selection', whyUs: 'Brand Philosophy', gifting: 'Ritual Kits', reviews: 'Customer Stories', newsletter: 'Insider List', navigation: 'Global Navigation' }[type] || type;
        }

        async function toggleSection(id) {
            const s = currentSections.find(sec => sec.id === id);
            if (!s) return;
            s.active = s.active === false;
            await db.collection('websiteContent').doc('homepage').update({ sections: currentSections });
            // Real-time listener handles UI refresh
        }

        function editSection(id) {
            editingSection = currentSections.find(s => s.id === id);
            if (!editingSection) return;
            document.getElementById('modalTitle').textContent = `Tailor ${getSectionName(editingSection.type)}`;
            generateEditForm(editingSection);
            document.getElementById('editModal').classList.add('show');
        }

        function generateEditForm(s) {
            const form = document.getElementById('modalForm');
            const data = s.data || {};
            let html = `<form onsubmit="saveSection(event)">
                <div class="form-group"><label class="form-label">Display Order</label><input type="number" class="form-input" id="edit-order" value="${s.order || 1}"></div>`;

            // Helper to generate input based on field name and value
            const generateInput = (key, value, label) => {
                if (key.toLowerCase().includes('image')) {
                    const previewId = `img-${key}`;
                    const warningId = `warning-${key}`;
                    return `
                        <div class="form-group">
                            <label class="form-label">${label}</label>
                            <div class="image-preview-container" id="preview-${key}">
                                <img src="${value ? cms.fixPath(value) : '../assets/images/placeholder.png'}" id="${previewId}">
                                <div class="upload-overlay" id="overlay-${key}" onclick="document.getElementById('file-${key}').click()">
                                    <span>‚ú® Change Image</span>
                                    <div class="progress-bar"><div class="progress-fill" id="progress-${key}"></div></div>
                                </div>
                            </div>
                            <input type="file" id="file-${key}" style="display:none;" onchange="uploadCMSImage('${key}', this.files[0])">
                            <div style="margin-top: 10px;">
                                <label class="form-label" style="font-size: 0.8rem;">Direct Image URL</label>
                                <input type="text" class="form-input" id="edit-${key}" value="${value || ''}" 
                                    placeholder="https://example.com/image.jpg"
                                    oninput="updateCMSPreview('${previewId}', '${warningId}', this.value)">
                                <div id="${warningId}" class="url-warning">
                                    ‚ö†Ô∏è This looks like a page link, not a direct image.
                                </div>
                            </div>
                        </div>
                    `;
                } else if (key === 'description' || key === 'text') {
                    return `<div class="form-group"><label class="form-label">${label}</label><textarea class="form-input" id="edit-${key}" rows="3">${value || ''}</textarea></div>`;
                } else {
                    return `<div class="form-group"><label class="form-label">${label}</label><input type="text" class="form-input" id="edit-${key}" value="${value || ''}"></div>`;
                }
            };

            // Common fields for simple sections
            const commonFields = {
                hero: ['title', 'tagline', 'description', 'image', 'buttonText', 'buttonLink'],
                collections: ['label', 'title', 'description', 'collections', 'buttonText', 'buttonLink'],
                bestSellers: ['label', 'title', 'description', 'image', 'buttonText', 'buttonLink'],
                whyUs: ['label', 'title', 'description', 'stats', 'features', 'badges'],
                gifting: ['label', 'title', 'description', 'image', 'buttonText', 'buttonLink'],
                reviews: ['label', 'title', 'rating', 'reviewCount', 'reviews', 'buttonText', 'buttonLink'],
                newsletter: ['title', 'description', 'placeholder', 'buttonText']
            };

            const fields = commonFields[s.type] || Object.keys(data);
            fields.forEach(f => {
                const label = f.charAt(0).toUpperCase() + f.slice(1).replace(/([A-Z])/g, ' $1');
                if (Array.isArray(data[f]) || f === 'collections' || f === 'reviews' || f === 'stats' || f === 'features' || f === 'badges') {
                    // Array field handling
                    html += `<div class="form-group"><label class="form-label">${label}</label><div id="array-container-${f}">`;
                    const items = data[f] || [];
                    items.forEach((item, idx) => {
                        html += `<div class="admin-card" style="padding: 1rem; margin-bottom: 1rem; border: 1px solid #eee;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>Item #${idx + 1}</strong>
                                <button type="button" class="btn-premium btn-premium-outline" style="padding: 4px 8px; font-size: 0.7rem;" onclick="removeArrayItem('${f}', ${idx})">Remove</button>
                            </div>`;

                        Object.keys(item).forEach(innerKey => {
                            const innerValue = item[innerKey];
                            const innerLabel = innerKey.charAt(0).toUpperCase() + innerKey.slice(1);

                            if (innerKey.toLowerCase().includes('image')) {
                                const previewId = `img-${f}-${idx}-${innerKey}`;
                                const warningId = `warning-${f}-${idx}-${innerKey}`;
                                html += `
                                    <div class="form-group">
                                        <label class="form-label">${innerLabel}</label>
                                        <div class="image-preview-container" id="preview-${f}-${idx}-${innerKey}" style="height: 120px;">
                                            <img src="${innerValue ? cms.fixPath(innerValue) : '../assets/images/placeholder.png'}" id="${previewId}">
                                            <div class="upload-overlay" id="overlay-${f}-${idx}-${innerKey}" onclick="document.getElementById('file-${f}-${idx}-${innerKey}').click()">
                                                <span>‚ú® Change</span>
                                                <div class="progress-bar"><div class="progress-fill" id="progress-${f}-${idx}-${innerKey}"></div></div>
                                            </div>
                                        </div>
                                        <input type="file" id="file-${f}-${idx}-${innerKey}" style="display:none;" onchange="uploadCMSImageArray('${f}', ${idx}, '${innerKey}', this.files[0])">
                                        <div style="margin-top: 8px;">
                                            <input type="text" class="form-input array-input" data-array="${f}" data-idx="${idx}" data-key="${innerKey}" 
                                                id="edit-${f}-${idx}-${innerKey}" value="${innerValue || ''}" placeholder="Direct URL"
                                                oninput="updateCMSPreview('${previewId}', '${warningId}', this.value)">
                                            <div id="${warningId}" class="url-warning">‚ö†Ô∏è Non-image link</div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                html += `<div class="form-group"><label class="form-label">${innerLabel}</label>
                                    <input type="text" class="form-input array-input" data-array="${f}" data-idx="${idx}" data-key="${innerKey}" value="${innerValue || ''}"></div>`;
                            }
                        });
                        html += `</div>`;
                    });
                    html += `</div><button type="button" class="btn-premium btn-premium-outline" style="width: 100%; margin-top: 0.5rem;" onclick="addArrayItem('${f}')">Add Item</button></div>`;
                } else {
                    html += generateInput(f, data[f] || '', label);
                }
            });

            html += `<div style="display: flex; gap: 12px; margin-top: 2rem;">
                <button type="submit" id="saveCMSBtn" class="btn-premium btn-premium-primary" style="flex: 2;">Save Masterpiece</button>
                <button type="button" class="btn-premium btn-premium-outline" style="flex: 1; border-color: #ff7675; color: #ff7675;" onclick="removeSection('${s.id}')">Delete</button>
                <button type="button" class="btn-premium btn-premium-outline" style="flex: 1;" onclick="closeModal()">Back</button>
            </div></form>`;
            form.innerHTML = html;
        }

        function updateCMSPreview(previewId, warningId, url) {
            const preview = document.getElementById(previewId);
            const warning = document.getElementById(warningId);
            const saveBtn = document.getElementById('saveCMSBtn');

            if (!url) {
                preview.src = '../assets/images/placeholder.png';
                warning.classList.remove('show');
                return;
            }

            const isPageLink = url.includes('pin.it') || (url.includes('pinterest.com') && !url.match(/\.(jpg|jpeg|png|webp|gif)/i));
            if (isPageLink) warning.classList.add('show');
            else warning.classList.remove('show');

            preview.src = url;
            if (saveBtn) saveBtn.disabled = false;
        }

        async function uploadCMSImageArray(arrayKey, idx, fieldKey, file) {
            if (!file) return;
            const progressFill = document.getElementById(`progress-${arrayKey}-${idx}-${fieldKey}`);
            const previewImg = document.getElementById(`img-${arrayKey}-${idx}-${fieldKey}`);
            const hiddenInput = document.getElementById(`edit-${arrayKey}-${idx}-${fieldKey}`);
            const overlay = document.getElementById(`overlay-${arrayKey}-${idx}-${fieldKey}`);
            const saveBtn = document.getElementById('saveCMSBtn');

            // Local Preview
            const reader = new FileReader();
            reader.onload = (e) => previewImg.src = e.target.result;
            reader.readAsDataURL(file);

            try {
                if (saveBtn) saveBtn.disabled = true;
                overlay.classList.add('uploading');
                progressFill.style.width = '0%';

                const storageRef = storage.ref(`cms/${Date.now()}_${file.name}`);
                const uploadTask = storageRef.put(file);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressFill.style.width = progress + '%';
                    },
                    (error) => {
                        console.error("Upload failed", error);
                        showToast("Upload failed", "error");
                        if (saveBtn) saveBtn.disabled = false;
                        overlay.classList.remove('uploading');
                    },
                    async () => {
                        try {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            hiddenInput.value = downloadURL;
                            previewImg.src = downloadURL;
                            showToast("Image uploaded!", "success");
                        } catch (e) { }
                        if (saveBtn) saveBtn.disabled = false;
                        overlay.classList.remove('uploading');
                    }
                );
            } catch (e) {
                console.error(e);
                showToast("Upload failed", "error");
                if (saveBtn) saveBtn.disabled = false;
            }
        }

        function addArrayItem(arrayKey) {
            const data = editingSection.data || {};
            if (!data[arrayKey]) data[arrayKey] = [];

            // Define schemas for new items
            const schemas = {
                collections: { title: 'New Collection', description: '', image: '', link: 'customer/products.html', price: 'From ‚Çπ0' },
                reviews: { initial: 'U', name: 'User', location: 'City', avatarColor: '#6B8A6B', stars: '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', title: 'Great!', text: 'Your review here', product: 'Product Name', date: 'Just now' },
                stats: { value: '0', label: 'Stat Label' },
                features: { icon: '‚ú®', title: 'Feature Title', description: 'Feature description' },
                badges: { icon: '‚ú®', text: 'Badge Text' }
            };

            data[arrayKey].push(schemas[arrayKey] || { title: 'New Item' });
            editingSection.data = data;
            generateEditForm(editingSection);
        }

        function removeArrayItem(arrayKey, idx) {
            const data = editingSection.data || {};
            if (data[arrayKey]) {
                data[arrayKey].splice(idx, 1);
                editingSection.data = data;
                generateEditForm(editingSection);
            }
        }

        async function uploadCMSImage(key, file) {
            if (!file) return;
            const progressFill = document.getElementById(`progress-${key}`);
            const previewImg = document.getElementById(`img-${key}`);
            const hiddenInput = document.getElementById(`edit-${key}`);
            const overlay = document.getElementById(`overlay-${key}`);
            const saveBtn = document.getElementById('saveCMSBtn');

            // Local Preview
            const reader = new FileReader();
            reader.onload = (e) => previewImg.src = e.target.result;
            reader.readAsDataURL(file);

            try {
                if (saveBtn) saveBtn.disabled = true;
                overlay.classList.add('uploading');
                progressFill.style.width = '0%';

                const storageRef = storage.ref(`cms/${Date.now()}_${file.name}`);
                const uploadTask = storageRef.put(file);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressFill.style.width = progress + '%';
                    },
                    (error) => {
                        console.error("Upload failed", error);
                        showToast("Upload failed", "error");
                        if (saveBtn) saveBtn.disabled = false;
                        overlay.classList.remove('uploading');
                    },
                    async () => {
                        try {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            hiddenInput.value = downloadURL;
                            previewImg.src = downloadURL;
                            showToast("Image uploaded!", "success");
                        } catch (e) { }
                        if (saveBtn) saveBtn.disabled = false;
                        overlay.classList.remove('uploading');
                    }
                );
            } catch (e) {
                console.error(e);
                showToast("Upload failed", "error");
                if (saveBtn) saveBtn.disabled = false;
            }
        }

        async function saveSection(e) {
            e.preventDefault();
            editingSection.order = parseInt(document.getElementById('edit-order').value);
            const data = editingSection.data || {};

            // Handle regular inputs
            const inputs = e.target.querySelectorAll('input:not(.array-input), textarea:not(.array-input)');
            inputs.forEach(input => {
                const id = input.id || '';
                if (id.startsWith('edit-') && !id.includes('-idx-')) {
                    const key = id.replace('edit-', '');
                    if (key !== 'order') {
                        data[key] = input.value;
                    }
                }
            });

            // Handle array inputs
            const arrayInputs = e.target.querySelectorAll('.array-input');
            arrayInputs.forEach(input => {
                const arrayKey = input.dataset.array;
                const idx = parseInt(input.dataset.idx);
                const key = input.dataset.key;

                if (!data[arrayKey]) data[arrayKey] = [];
                if (!data[arrayKey][idx]) data[arrayKey][idx] = {};
                data[arrayKey][idx][key] = input.value;
            });

            editingSection.data = data;
            try {
                showLoading(true);
                if (currentPage === 'navigation') {
                    await db.collection('websiteContent').doc('navigation').set({ links: data.links });
                } else {
                    await db.collection('websiteContent').doc(currentPage).update({ sections: currentSections });
                }
                closeModal();
                showToast('Changes etched in stone.', 'success');
            } catch (e) {
                showToast('Save failed', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function addSection() {
            const type = prompt("Enter section type (hero, collections, bestSellers, whyUs, gifting, reviews, newsletter):");
            if (!type) return;

            const newSection = {
                id: type + '_' + Date.now(),
                type: type,
                order: currentSections.length + 1,
                active: true,
                data: {}
            };

            currentSections.push(newSection);
            await db.collection('websiteContent').doc(currentPage).set({ sections: currentSections }, { merge: true });
            showToast("New section added", "success");
        }

        async function removeSection(id) {
            if (!confirm("Are you sure you want to remove this section? This cannot be undone.")) return;
            currentSections = currentSections.filter(s => s.id !== id);
            await db.collection('websiteContent').doc(currentPage).update({ sections: currentSections });
            closeModal();
            showToast("Section removed", "success");
        }

        function closeModal() { document.getElementById('editModal').classList.remove('show'); }

        function exportContent() {
            const blob = new Blob([JSON.stringify({ settings: currentSettings, themes: currentThemes, sections: currentSections }, null, 2)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'akira-content.json'; a.click();
        }
    </script>
</body>

</html>