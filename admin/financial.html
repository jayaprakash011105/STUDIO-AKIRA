<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Reports - STUDIO AKIRA Admin</title>

    <!-- CSS -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        .financial-header {
            margin-bottom: 30px;
        }

        .financial-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--color-sage);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            display: block;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-sage-dark);
            margin-bottom: 8px;
            font-family: inherit;
            line-height: 1.2;
        }

        .stat-label {
            color: var(--color-text-light);
            font-size: 0.95rem;
            font-weight: 500;
            font-family: inherit;
        }

        .stat-change {
            font-size: 0.85rem;
            margin-top: 8px;
            font-family: inherit;
            color: var(--color-text-light);
        }

        .stat-change.positive {
            color: var(--color-success);
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: 30px;
        }

        .chart-container h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-sage-darker);
            margin-bottom: 25px;
            font-family: inherit;
        }

        .payment-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .payment-item {
            background: var(--color-background);
            padding: 25px;
            border-radius: var(--radius-md);
            text-align: center;
            transition: all 0.3s;
        }

        .payment-item:hover {
            background: var(--color-sage-light);
            transform: translateY(-2px);
        }

        .payment-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--color-sage-dark);
            margin-bottom: 8px;
            font-family: inherit;
        }

        .payment-label {
            color: var(--color-text);
            font-size: 0.95rem;
            font-weight: 500;
            font-family: inherit;
        }

        .payment-count {
            color: var(--color-text-light);
            font-size: 0.85rem;
            margin-top: 5px;
            font-family: inherit;
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-logo">studio akira</div>
        <ul class="sidebar-menu">
            <li class="sidebar-item"><a href="dashboard.html" class="sidebar-link">üìä Dashboard</a></li>
            <li class="sidebar-item"><a href="products.html" class="sidebar-link">üïØÔ∏è Products</a></li>
            <li class="sidebar-item"><a href="orders.html" class="sidebar-link">üì¶ Orders</a></li>
            <li class="sidebar-item"><a href="users.html" class="sidebar-link">üë• Users</a></li>
            <li class="sidebar-item"><a href="approvals.html" class="sidebar-link">‚úÖ Approvals</a></li>
            <li class="sidebar-item"><a href="financial.html" class="sidebar-link active">üí∞ Financial</a></li>
            <li class="sidebar-item"><a href="content.html" class="sidebar-link">üìù Content</a></li>
            <li class="sidebar-item"><a href="#" class="sidebar-link" onclick="logout()">üö™ Logout</a></li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="financial-header">
            <h1>Financial Reports</h1>
            <p style="color: var(--color-text-light); font-size: 1rem;">Monitor revenue, sales, and payment analytics
            </p>
        </div>

        <!-- Financial Statistics -->
        <div class="financial-stats">
            <div class="stat-card">
                <span class="stat-icon">üí∞</span>
                <div class="stat-value" id="totalRevenue">‚Çπ0</div>
                <div class="stat-label">Total Revenue</div>
                <div class="stat-change">All time earnings</div>
            </div>

            <div class="stat-card">
                <span class="stat-icon">üìà</span>
                <div class="stat-value" id="monthlyRevenue">‚Çπ0</div>
                <div class="stat-label">This Month</div>
                <div class="stat-change positive" id="monthlyChange">Current month</div>
            </div>

            <div class="stat-card">
                <span class="stat-icon">üìä</span>
                <div class="stat-value" id="averageOrder">‚Çπ0</div>
                <div class="stat-label">Average Order Value</div>
                <div class="stat-change">Per order</div>
            </div>

            <div class="stat-card">
                <span class="stat-icon">üõçÔ∏è</span>
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">Total Orders</div>
                <div class="stat-change">Completed orders</div>
            </div>

            <div class="stat-card">
                <span class="stat-icon">üí≥</span>
                <div class="stat-value" id="codOrders">0</div>
                <div class="stat-label">COD Orders</div>
                <div class="stat-change">Cash on Delivery</div>
            </div>

            <div class="stat-card">
                <span class="stat-icon">üåê</span>
                <div class="stat-value" id="onlineOrders">0</div>
                <div class="stat-label">Online Payments</div>
                <div class="stat-change">Digital transactions</div>
            </div>
        </div>

        <!-- Payment Method Breakdown -->
        <div class="chart-container">
            <h2>Payment Method Breakdown</h2>
            <div class="payment-breakdown" id="paymentBreakdown">
                <div class="payment-item">
                    <div class="payment-value">‚Çπ0</div>
                    <div class="payment-label">Cash on Delivery</div>
                    <div class="payment-count">0 orders</div>
                </div>
                <div class="payment-item">
                    <div class="payment-value">‚Çπ0</div>
                    <div class="payment-label">Credit Card</div>
                    <div class="payment-count">0 orders</div>
                </div>
                <div class="payment-item">
                    <div class="payment-value">‚Çπ0</div>
                    <div class="payment-label">Debit Card</div>
                    <div class="payment-count">0 orders</div>
                </div>
                <div class="payment-item">
                    <div class="payment-value">‚Çπ0</div>
                    <div class="payment-label">Online Payment</div>
                    <div class="payment-count">0 orders</div>
                </div>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="chart-container">
            <h2>Recent Transactions</h2>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Payment Method</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTable">
                        <tr>
                            <td colspan="6" class="text-center">Loading transactions...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Loading Spinner -->
    <div id="loading-spinner">
        <div class="spinner"></div>
    </div>

    <!-- Scripts -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        checkRole(['admin']).then(user => {
            if (user) loadFinancialData();
        });

        async function loadFinancialData() {
            try {
                const ordersSnapshot = await db.collection('orders').get();
                let totalRevenue = 0;
                let monthlyRevenue = 0;
                let codRevenue = 0;
                let creditCardRevenue = 0;
                let debitCardRevenue = 0;
                let onlineRevenue = 0;
                let codCount = 0;
                let creditCount = 0;
                let debitCount = 0;
                let onlineCount = 0;

                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                ordersSnapshot.forEach(doc => {
                    const order = doc.data();
                    const amount = order.totalAmount || 0;
                    totalRevenue += amount;

                    // Calculate monthly revenue
                    if (order.createdAt) {
                        const orderDate = order.createdAt.toDate();
                        if (orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear) {
                            monthlyRevenue += amount;
                        }
                    }

                    // Payment method breakdown
                    const paymentMethod = order.paymentMethod || 'cod';
                    if (paymentMethod === 'cod') {
                        codRevenue += amount;
                        codCount++;
                    } else if (paymentMethod === 'credit_card') {
                        creditCardRevenue += amount;
                        creditCount++;
                    } else if (paymentMethod === 'debit_card') {
                        debitCardRevenue += amount;
                        debitCount++;
                    } else if (paymentMethod === 'online') {
                        onlineRevenue += amount;
                        onlineCount++;
                    }
                });

                const totalOrders = ordersSnapshot.size;
                const averageOrder = totalOrders > 0 ? totalRevenue / totalOrders : 0;
                const totalOnlineCount = creditCount + debitCount + onlineCount;

                // Update statistics
                document.getElementById('totalRevenue').textContent = formatPrice(totalRevenue);
                document.getElementById('monthlyRevenue').textContent = formatPrice(monthlyRevenue);
                document.getElementById('averageOrder').textContent = formatPrice(averageOrder);
                document.getElementById('totalOrders').textContent = totalOrders;
                document.getElementById('codOrders').textContent = codCount;
                document.getElementById('onlineOrders').textContent = totalOnlineCount;

                // Update payment breakdown
                const paymentBreakdown = document.getElementById('paymentBreakdown');
                paymentBreakdown.innerHTML = `
                    <div class="payment-item">
                        <div class="payment-value">${formatPrice(codRevenue)}</div>
                        <div class="payment-label">Cash on Delivery</div>
                        <div class="payment-count">${codCount} orders</div>
                    </div>
                    <div class="payment-item">
                        <div class="payment-value">${formatPrice(creditCardRevenue)}</div>
                        <div class="payment-label">Credit Card</div>
                        <div class="payment-count">${creditCount} orders</div>
                    </div>
                    <div class="payment-item">
                        <div class="payment-value">${formatPrice(debitCardRevenue)}</div>
                        <div class="payment-label">Debit Card</div>
                        <div class="payment-count">${debitCount} orders</div>
                    </div>
                    <div class="payment-item">
                        <div class="payment-value">${formatPrice(onlineRevenue)}</div>
                        <div class="payment-label">Online Payment</div>
                        <div class="payment-count">${onlineCount} orders</div>
                    </div>
                `;

                // Load recent transactions
                loadRecentTransactions();

            } catch (error) {
                console.error('Error loading financial data:', error);
                showToast('Error loading financial data', 'error');
            }
        }

        async function loadRecentTransactions() {
            try {
                const snapshot = await db.collection('orders')
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();

                const tbody = document.getElementById('transactionsTable');

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center" style="padding: 40px; color: var(--color-text-light);">No transactions yet</td></tr>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const order = doc.data();
                    const orderId = doc.id.substring(0, 8).toUpperCase();
                    const paymentBadge = order.paymentMethod ?
                        `<span class="badge badge-info">${order.paymentMethod}</span>` :
                        '<span class="badge badge-secondary">N/A</span>';

                    html += `
                    <tr>
                        <td><strong>#${orderId}</strong></td>
                        <td>${order.customerDetails?.name || 'N/A'}</td>
                        <td><strong>${formatPrice(order.totalAmount)}</strong></td>
                        <td>${paymentBadge}</td>
                        <td>${getStatusBadge(order.status)}</td>
                        <td>${formatDate(order.createdAt)}</td>
                    </tr>
                    `;
                });
                tbody.innerHTML = html;
            } catch (error) {
                console.error('Error loading transactions:', error);
                document.getElementById('transactionsTable').innerHTML = '<tr><td colspan="6" class="text-center">Error loading transactions</td></tr>';
            }
        }
    </script>
</body>

</html>